<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Zulia - Gesti贸n de Combustible</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Librer铆a para leer Excel (.xlsx) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDwaK4Z26RfqDwNvwdMqri08oEjwG9qymc",
            authDomain: "almacen-airtek.firebaseapp.com",
            projectId: "almacen-airtek",
            storageBucket: "almacen-airtek.firebasestorage.app",
            messagingSenderId: "934058211778",
            appId: "1:934058211778:web:acbbec880576b6cea5fe5b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.fb = { db, auth, collection, addDoc, onSnapshot, query, orderBy, doc, signInAnonymously, onAuthStateChanged };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; }
        .glass-panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.5); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const NODOS_ZULIA = [
            { id: 1, nombre: "Datacenter/sede 18 de Octubre", capacidadTanque: 305, reserva: 230, tasaConsumo: 20 },
            { id: 2, nombre: "Datacenter/nodo El Callao", capacidadTanque: 305, reserva: 800, tasaConsumo: 20 },
            { id: 3, nombre: "Comedor", capacidadTanque: 330, reserva: 230, tasaConsumo: 18 },
            { id: 4, nombre: "Nodo Bachaquero", capacidadTanque: 1000, reserva: 0, tasaConsumo: 6 },
            { id: 5, nombre: "Nodo Los Puertos de Altagracia", capacidadTanque: 1100, reserva: 1000, tasaConsumo: 6 },
            { id: 6, nombre: "Nodo Cabimas", capacidadTanque: 80, reserva: 1396, tasaConsumo: 6 },
            { id: 7, nombre: "Nodo Ciudad Ojeda", capacidadTanque: 80, reserva: 1145, tasaConsumo: 6 },
            { id: 10, nombre: "Nodo Lago Caribe", capacidadTanque: 80, reserva: 429, tasaConsumo: 6 },
            { id: 16, nombre: "Nodo Machiques", capacidadTanque: 300, reserva: 1000, tasaConsumo: 10 },
            { id: 23, nombre: "Nodo/sede Santa Cruz de Mara", capacidadTanque: 100, reserva: 200, tasaConsumo: 6 }
        ];

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [selectedId, setSelectedId] = useState('all');
            const [user, setUser] = useState(null);
            const [dataLogs, setDataLogs] = useState({ consumos: [], surtidos: [] });
            const [uploadStatus, setUploadStatus] = useState(null);

            const today = new Date().toISOString().split('T')[0];
            const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            const [dateStart, setDateStart] = useState(firstDay);
            const [dateEnd, setDateEnd] = useState(today);

            const appId = "almacen-airtek";
            const BASE_PATH = ["artifacts", appId, "public", "data"];

            useEffect(() => {
                if (!window.fb) return;
                const { auth, db, signInAnonymously, onAuthStateChanged, onSnapshot, collection } = window.fb;

                signInAnonymously(auth).catch(err => console.error("Error Auth An贸nima:", err));
                
                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        onSnapshot(collection(db, ...BASE_PATH, "consumos_zulia"), (snapshot) => {
                            const docs = snapshot.docs.map(d => d.data());
                            setDataLogs(prev => ({ ...prev, consumos: docs }));
                        }, (err) => console.error("Error leyendo consumos:", err));

                        onSnapshot(collection(db, ...BASE_PATH, "surtidos_zulia"), (snapshot) => {
                            const docs = snapshot.docs.map(d => d.data());
                            setDataLogs(prev => ({ ...prev, surtidos: docs }));
                        }, (err) => console.error("Error leyendo surtidos:", err));
                    }
                });
            }, []);

            const processData = async (rows, type) => {
                const { db, collection, addDoc } = window.fb;
                const collectionName = type === 'consumos' ? 'consumos_zulia' : 'surtidos_zulia';
                let count = 0;
                
                try {
                    const targetCollection = collection(db, ...BASE_PATH, collectionName);
                    for (const row of rows) {
                        // Soporta tanto formato array (CSV) como objeto (Excel con encabezados)
                        const fecha = row.fecha || row[0];
                        const nodoId = row.nodoId || row[1];
                        const valor = row.valor || row[2];

                        if (fecha && nodoId && valor !== undefined) {
                            await addDoc(targetCollection, {
                                fecha: String(fecha).trim(),
                                nodoId: parseInt(nodoId),
                                valor: Math.max(0, parseFloat(valor)),
                                createdAt: new Date().toISOString()
                            });
                            count++;
                        }
                    }
                    setUploadStatus(`Sincronizado: ${count} registros nuevos.`);
                } catch (err) {
                    setUploadStatus("Error al guardar en base de datos.");
                    console.error(err);
                }
            };

            const handleFileUpload = async (e, type) => {
                const file = e.target.files[0];
                if (!file || !user) return;

                setUploadStatus("Leyendo archivo...");
                const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
                const reader = new FileReader();

                reader.onload = async (event) => {
                    try {
                        let dataToProcess = [];
                        if (isExcel) {
                            const workbook = XLSX.read(event.target.result, { type: 'binary' });
                            const sheetName = workbook.SheetNames[0];
                            // Convierte a JSON asumiendo que la primera fila son encabezados: fecha, nodoId, valor
                            dataToProcess = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                        } else {
                            const text = event.target.result;
                            const lines = text.split('\n').slice(1); // Ignorar cabecera
                            dataToProcess = lines.map(line => line.split(','));
                        }
                        
                        await processData(dataToProcess, type);
                    } catch (err) {
                        setUploadStatus("Error procesando el formato del archivo.");
                        console.error(err);
                    }
                    setTimeout(() => setUploadStatus(null), 4000);
                };

                if (isExcel) {
                    reader.readAsBinaryString(file);
                } else {
                    reader.readAsText(file);
                }
            };

            const calculatedMetrics = useMemo(() => {
                const nodesToProcess = selectedId === 'all' 
                    ? NODOS_ZULIA 
                    : NODOS_ZULIA.filter(n => n.id === parseInt(selectedId));

                const start = new Date(dateStart);
                const end = new Date(dateEnd);
                const diffDays = Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) || 1;

                let totals = { capacidad: 0, reserva: 0, consumo: 0, surtido: 0, horas: 0 };

                nodesToProcess.forEach(nodo => {
                    const consumosNodo = dataLogs.consumos.filter(c => 
                        c.nodoId === nodo.id && new Date(c.fecha) >= start && new Date(c.fecha) <= end
                    );
                    const surtidosNodo = dataLogs.surtidos.filter(s => 
                        s.nodoId === nodo.id && new Date(s.fecha) >= start && new Date(s.fecha) <= end
                    );

                    const horasNodo = Math.max(0, consumosNodo.reduce((acc, curr) => acc + curr.valor, 0));
                    const litrosSurtidos = Math.max(0, surtidosNodo.reduce((acc, curr) => acc + curr.valor, 0));

                    const hFinal = horasNodo || 0;
                    const sFinal = litrosSurtidos || 0;

                    totals.capacidad += nodo.capacidadTanque;
                    totals.reserva += nodo.reserva;
                    totals.consumo += (hFinal * nodo.tasaConsumo);
                    totals.surtido += sFinal;
                    totals.horas += hFinal;
                });

                const capTotal = totals.capacidad + totals.reserva;
                let disponibilidadOperativa = capTotal - totals.consumo + totals.surtido;
                const disponibilidad = Math.max(0, disponibilidadOperativa);

                return { ...totals, capTotal, disponibilidad, dias: diffDays };
            }, [selectedId, dateStart, dateEnd, dataLogs]);

            const formatNum = (num) => (num || 0).toLocaleString();

            return (
                <div className="min-h-screen flex flex-col md:flex-row overflow-hidden">
                    <aside className="w-full md:w-80 bg-slate-900/50 border-r border-slate-800 p-8 flex flex-col gap-8 shrink-0">
                        <div className="flex items-center gap-3 px-2">
                            <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center font-black italic">Z</div>
                            <div>
                                <h1 className="text-xl font-black text-white">GE-ZULIA</h1>
                                <p className="text-[10px] text-blue-400 font-bold uppercase tracking-widest">Proyecto: Almac茅n Airtek</p>
                            </div>
                        </div>

                        <nav className="flex-1 space-y-2">
                            <button onClick={() => setView('dashboard')} className={`w-full text-left px-5 py-3 rounded-xl font-bold text-sm transition-all ${view === 'dashboard' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}> Tablero</button>
                            <button onClick={() => setView('upload')} className={`w-full text-left px-5 py-3 rounded-xl font-bold text-sm transition-all ${view === 'upload' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}> Cargar Datos</button>
                        </nav>
                        
                        <div className="mt-auto p-4 glass-panel rounded-2xl">
                            <p className="text-[10px] font-black text-slate-500 uppercase mb-2">Estado Sincronizaci贸n</p>
                            <div className="text-[10px] text-slate-300">
                                DB: <span className="text-emerald-400 font-bold">Conectado</span>
                            </div>
                        </div>
                    </aside>

                    <main className="flex-1 p-6 md:p-12 overflow-y-auto bg-slate-950 custom-scrollbar">
                        {view === 'dashboard' ? (
                            <>
                                <header className="flex flex-col xl:flex-row xl:items-end justify-between gap-6 mb-12">
                                    <div>
                                        <h2 className="text-4xl font-black text-white mb-2 uppercase tracking-tighter">Portal Zulia</h2>
                                        <p className="text-slate-400 font-medium italic">Monitor de disponibilidad: Capacidad - Consumo + Surtido.</p>
                                    </div>
                                    <div className="flex flex-wrap gap-4 p-3 bg-slate-900 rounded-2xl border border-slate-800">
                                        <div className="flex items-center gap-4 px-2">
                                            <input type="date" value={dateStart} onChange={e => setDateStart(e.target.value)} className="bg-transparent text-white text-xs font-bold outline-none border-b border-slate-700" />
                                            <span className="text-slate-600 text-xs">al</span>
                                            <input type="date" value={dateEnd} onChange={e => setDateEnd(e.target.value)} className="bg-transparent text-white text-xs font-bold outline-none border-b border-slate-700" />
                                        </div>
                                        <select value={selectedId} onChange={e => setSelectedId(e.target.value)} className="bg-transparent text-white text-sm font-bold outline-none cursor-pointer">
                                            <option value="all" className="bg-slate-900"> TODOS LOS NODOS</option>
                                            {NODOS_ZULIA.map(n => <option key={n.id} value={n.id} className="bg-slate-900">{n.nombre}</option>)}
                                        </select>
                                    </div>
                                </header>

                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div className="glass-panel p-6 rounded-3xl border-l-4 border-l-blue-500">
                                        <p className="text-[10px] font-black text-slate-500 uppercase mb-2">Capacidad Red</p>
                                        <p className="text-3xl font-black text-blue-400">{formatNum(calculatedMetrics.capTotal)} L</p>
                                    </div>
                                    <div className="glass-panel p-6 rounded-3xl border-l-4 border-l-emerald-500">
                                        <p className="text-[10px] font-black text-slate-500 uppercase mb-2">Disponible</p>
                                        <p className="text-3xl font-black text-emerald-400">{formatNum(calculatedMetrics.disponibilidad)} L</p>
                                        <span className="text-[9px] text-slate-500 font-bold uppercase tracking-tighter italic block mt-1">Cap - Cons + Surt</span>
                                    </div>
                                    <div className="glass-panel p-6 rounded-3xl border-l-4 border-l-orange-500">
                                        <p className="text-[10px] font-black text-slate-500 uppercase mb-2">Consumo Periodo</p>
                                        <p className="text-3xl font-black text-orange-400">{formatNum(calculatedMetrics.consumo)} L</p>
                                    </div>
                                    <div className="glass-panel p-6 rounded-3xl border-l-4 border-l-purple-500">
                                        <p className="text-[10px] font-black text-slate-500 uppercase mb-2">Surtido Periodo</p>
                                        <p className="text-3xl font-black text-purple-400">{formatNum(calculatedMetrics.surtido)} L</p>
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="max-w-4xl mx-auto py-12">
                                <h2 className="text-4xl font-black text-white mb-4 uppercase">Gesti贸n de Datos Airtek</h2>
                                <p className="text-slate-400 mb-12">Sincroniza archivos CSV o Excel (.xlsx) con columnas: <span className="text-blue-400 font-mono">fecha, nodoId, valor</span>.</p>

                                {uploadStatus && (
                                    <div className="mb-8 p-4 bg-blue-500/10 border border-blue-500 text-blue-400 font-bold rounded-2xl">
                                        {uploadStatus}
                                    </div>
                                )}

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div className="glass-panel p-8 rounded-[2.5rem] border-t-2 border-orange-500">
                                        <h3 className="text-xl font-black text-orange-400 mb-4 uppercase">Cargar Consumos</h3>
                                        <p className="text-[10px] text-slate-500 mb-4 italic">Formatos: .csv, .xlsx</p>
                                        <input type="file" accept=".csv, .xlsx, .xls" onChange={(e) => handleFileUpload(e, 'consumos')} className="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-orange-500/10 file:text-orange-500 cursor-pointer" />
                                    </div>
                                    <div className="glass-panel p-8 rounded-[2.5rem] border-t-2 border-purple-500">
                                        <h3 className="text-xl font-black text-purple-400 mb-4 uppercase">Cargar Surtidos</h3>
                                        <p className="text-[10px] text-slate-500 mb-4 italic">Formatos: .csv, .xlsx</p>
                                        <input type="file" accept=".csv, .xlsx, .xls" onChange={(e) => handleFileUpload(e, 'surtidos')} className="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-purple-500/10 file:text-purple-500 cursor-pointer" />
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
